<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>Competency Matching Game</title>
<style>
/* --- Main game and leaderboard styles --- */
* {margin:0;padding:0;box-sizing:border-box; font-family: system-ui, -apple-system, sans-serif;}
body {min-height:100vh; background:linear-gradient(135deg,#EEF2FF,#DBEAFE); display:flex;align-items:center;justify-content:center;padding:1rem;}
.game-container {width:100%;max-width:56rem;background:white;border-radius:0.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);overflow:hidden;}
.instruction-overlay {width:100%;min-height:100vh;background:linear-gradient(135deg,#f5f3ff 0%,#f0fdfa 100%);display:flex;align-items:center;justify-content:center;position:fixed;inset:0;z-index:99;opacity:1;transition:opacity 0.5s;}
.instruction-box {background:#fff;border-radius:1.5rem;box-shadow:0 6px 32px 0 rgba(80, 72, 229, 0.08);padding:2.5rem 2rem 2rem 2rem;max-width:28rem;width:100%;text-align:center;margin:1.5rem;animation:popIn 0.6s cubic-bezier(.23,1.02,.92,1.16);}
@keyframes popIn {0%{opacity:0;transform:scale(0.92);}100%{opacity:1;transform:scale(1);}
}
.instruction-title {color:#8368d7;font-size:2rem;font-weight:bold;margin-bottom:1.5rem;letter-spacing:0.01em;}
.instruction-text {font-size:1.15rem;color:#4b5563;margin-bottom:1.7rem;line-height:1.6;}
.instruction-text strong {font-weight:bold;}
.instruction-highlight {color:#9f7aea;font-size:1.1rem;margin-bottom:2rem;font-weight:600;letter-spacing:0.01em;}
.start-btn {background:#14d8a6;color:#fff;padding:0.9rem 2.2rem;border:none;border-radius:1.5rem;font-size:1.25rem;font-weight:700;cursor:pointer;box-shadow:0 3px 10px 0 #14d8a62a;transition:background 0.18s;}
.start-btn:hover {background:#0ea5e9;}
.game-header {padding:1rem;background:#4F46E5;color:white;display:flex;flex-direction:column;gap:0.5rem;}
@media (min-width:640px){.game-header{flex-direction:row;justify-content:space-between;align-items:center;}}
.game-title {font-size:1.5rem;font-weight:bold;}
.game-subtitle {opacity:0.9;font-size:0.875rem;}
.game-stats {display:flex;gap:1rem;margin-top:0.5rem;}
@media (min-width:640px){.game-stats{margin-top:0;}}
.stat {text-align:center;}
.stat-label {font-size:0.75rem;text-transform:uppercase;letter-spacing:0.05em;opacity:0.8;}
.stat-value {font-size:1.25rem;font-weight:bold;}
.timer-bar {padding:0.5rem 1rem;}
.timer-track {height:0.75rem;background:#E5E7EB;border-radius:9999px;overflow:hidden;}
.timer-fill {height:100%;transition:width 1s linear,background-color 0.3s;}
.current-competency, .pair-instruction {padding:1rem;text-align:center;}
.competency-label {font-size:1.5rem;font-weight:bold;color:#1F2937;margin-bottom:0.25rem;}
.competency-tag {display:inline-block;padding:0.5rem 1.5rem;background:#EEF2FF;color:#4F46E5;font-weight:600;font-size:1.25rem;border-radius:9999px;}
.blocks-grid, .l3-grid {display:grid;grid-template-columns:1fr;gap:0.75rem;padding:1rem;}
@media (min-width:400px){.blocks-grid, .l3-grid{grid-template-columns:repeat(2,1fr);}}
@media (min-width:640px){.blocks-grid, .l3-grid{grid-template-columns:repeat(3,1fr);}}
@media (min-width:768px){.blocks-grid, .l3-grid{grid-template-columns:repeat(4,1fr);}}
.block, .l3-block {
    min-height: 4.5rem;
    height: auto;
    border: 2px solid;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    text-align: center;
    font-weight: 500;
    user-select: none;
    font-size: 1.05rem;
    background: #f3f4f6;
    word-break: break-word;
    min-width: 0;
    margin: 0 auto;
    max-width: 100%;
    box-sizing: border-box;
}
.block:hover, .l3-block:hover {transform:translateY(-2px);box-shadow:0 4px 6px -1px rgba(0,0,0,0.07);}
.block.eliminated, .l3-block.eliminated {opacity:0;transform:scale(0);pointer-events:none;}
.block.selected {border-width:3px !important;box-shadow:0 0 0 3px #fcd34d66;z-index:1;}
.block.shake, .l3-block.shake {animation:shake 0.5s ease-in-out;}
.l3-block.correct {background:#c6f6d5;border-color:#10b981;color:#065f46;animation:burstScaleFade 0.7s cubic-bezier(.4,2.1,.5,1) forwards;}
@keyframes shake {0%{transform:translateX(0);}20%{transform:translateX(-5px);}40%{transform:translateX(5px);}60%{transform:translateX(-5px);}80%{transform:translateX(5px);}100%{transform:translateX(0);}
}
.block.bursting, .l3-block.bursting {animation:burstScaleFade 0.7s cubic-bezier(.4,2.1,.5,1) forwards;z-index:10;}
@keyframes burstScaleFade {0%{transform:scale(1) rotate(0deg);opacity:1;}55%{transform:scale(1.4) rotate(8deg);opacity:1;}100%{transform:scale(0.5) rotate(-18deg);opacity:0;}
}
.particle {position:absolute;width:12px;height:12px;border-radius:50%;background:#FCD34D;pointer-events:none;z-index:20;}
.confetti {position:fixed;z-index:3000;pointer-events:none;width:100vw;height:100vh;left:0;top:0;}
.modal-overlay {position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:50;}
.modal {background:white;border-radius:0.75rem;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);padding:1.5rem;width:100%;max-width:42rem;max-height:90vh;overflow-y:auto;}
.success-icon {width:5rem;height:5rem;margin:0 auto 1rem;background:#D1FAE5;border-radius:9999px;display:flex;align-items:center;justify-content:center;color:#059669;font-size:3rem;}
.modal-title {font-size:1.5rem;font-weight:bold;color:#1F2937;text-align:center;margin-bottom:0.5rem;}
.modal-stats {display:flex;justify-content:center;gap:2rem;margin-bottom:1.5rem;}
.modal-stat {text-align:center;}
.modal-stat-label {font-size:0.875rem;font-weight:500;color:#6B7280;}
.modal-stat-value {font-size:1.875rem;font-weight:bold;color:#4F46E5;}
.modal-message {text-align:center;color:#4B5563;margin-bottom:1.5rem;}
.button-group {display:flex;flex-direction:column;gap:0.75rem;justify-content:center;}
@media (min-width:640px){.button-group{flex-direction:row;}}
.button {padding:0.5rem 1.5rem;border-radius:0.5rem;font-weight:600;cursor:pointer;transition:background-color 0.2s;border:none;color:white;}
.button-primary {background:#4F46E5;}
.button-primary:hover {background:#4338CA;}
.button-success {background:#059669;}
.button-success:hover {background:#047857;}
.competency-mapping {margin-top:1.5rem;}
.mapping-title {font-size:1.25rem;font-weight:600;color:#1F2937;margin-bottom:0.75rem;}
.mapping-grid {display:grid;grid-template-columns:1fr;gap:1rem;}
@media (min-width:768px){.mapping-grid{grid-template-columns:repeat(2,1fr);}}
.mapping-card {padding:0.75rem;border-radius:0.5rem;border:1px solid;}
.mapping-card-title {font-weight:bold;color:#1F2937;}
.mapping-list {margin-top:0.5rem;list-style-position:inside;color:#4B5563;}
.level2-feedback {text-align:center;padding:1rem 0;font-size:1.5rem;font-weight:bold;color:#6D28D9;transition:all 0.3s;}
.pairs-summary {margin:2rem 0 1rem 0;text-align:center;}
.pairs-bucket {margin-bottom:1.5rem;}
.pairs-bucket-title {font-size:1.2rem;font-weight:bold;margin-bottom:0.5rem;color:#1F2937;}
.pairs-list {list-style:none;padding:0;}
.pairs-list li {margin-bottom:0.3em;color:#4B5563;}
.competency-flash {position:fixed;left:0;right:0;top:0;bottom:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:1000;animation:compFlashInOut 1.2s cubic-bezier(.4,2,.4,1.1);}
@keyframes compFlashInOut {0%{opacity:0;transform:scale(0.6);}10%{opacity:1;transform:scale(1.1);}60%{opacity:1;transform:scale(1);}100%{opacity:0;transform:scale(1.3);}
}
.competency-flash-text {font-size:3rem;font-weight:900;color:#fff;text-shadow:0 8px 32px #0007,0 0 24px currentColor;padding:2rem 3rem;border-radius:2rem;box-shadow:0 0 50px 15px currentColor;background:rgba(70,70,220,0.9);border:6px solid;filter:drop-shadow(0 0 32px currentColor);}
.l3-summary-scroll {max-height:60vh;overflow-y:auto;padding:0.5rem 0.5rem 1.1rem 0.5rem;margin:0 auto;width:96%;}
.l3-summary-block {background:#f6f7fb;border-radius:0.65rem;box-shadow:0 2px 8px 0 #0001;border:1.5px solid #E5E7EB;margin-bottom:1.5rem;padding:1.1rem 1.5rem 1.1rem 1.5rem;max-width:700px;margin-left:auto;margin-right:auto;}
.l3-summary-main-title {font-size:1.28rem;font-weight:bold;color:#3b2e7e;margin-bottom:0.55rem;text-align:center;letter-spacing:0.01em;}
.l3-summary-sub-title {font-size:1.06rem;font-weight:bold;color:#22223b;margin-bottom:0.16rem;}
.l3-summary-def {font-size:0.98rem;color:#424254;margin-bottom:0.6rem;}
.l3-tryagain-main {font-size:1.7rem;font-weight:bold;color:#f87171;text-align:center;margin-top:3rem;margin-bottom:1.2rem;}
.l3-tryagain-msg {text-align:center;font-size:1.13rem;color:#374151;margin-bottom:2rem;}
.l3-main-title {font-size:2rem;font-weight:bold;text-align:center;margin:1.2rem 0 0.3rem 0;}
.l3-def-label {text-align:center;font-size:1.09rem;color:#333c;margin-bottom:0.1rem;}
.l3-def-box {text-align:center;font-size:1.15rem;color:#23232b;margin-bottom:0.7rem;margin-top:0.2rem;}
html, body {max-width: 100vw; overflow-x: hidden;}
/* --- Leaderboard styles --- */
.leaderboard-overlay {
  position: fixed; inset: 0; background: linear-gradient(135deg, #aee2f5 0%, #a0eec0 100%);
  z-index: 1000; display: flex; align-items: center; justify-content: center;
  transition: opacity 0.4s;
}
.leaderboard-container {
  background: #fff;
  border-radius: 2.2rem;
  box-shadow: 0 8px 44px 0 #0002;
  max-width: 380px;
  width: 100%;
  padding: 2.2rem 1.2rem 2.8rem 1.2rem;
  position: relative;
}
.leaderboard-title {
  font-weight: 800;
  font-size: 2rem;
  text-align: center;
  letter-spacing: 0.01em;
  margin-bottom: 1.4rem;
  color: #16213e;
}
.leaderboard-list {
  padding: 0;
  margin: 0;
  list-style: none;
}
.leaderboard-entry {
  display: flex;
  align-items: center;
  padding: 1.1rem 0 1.1rem 0;
  border-bottom: 1px solid #f3f4f8;
  gap: 0.8rem;
}
.leaderboard-entry:last-child {
  border-bottom: none;
}
.avatar {
  width: 54px;
  height: 54px;
  border-radius: 16px;
  background: #f3f4f8;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}
.player-info {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  min-width: 0;
}
.player-name {
  font-weight: 700;
  font-size: 1.12rem;
  color: #222;
  line-height: 1.07;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.player-score {
  font-size: 1.1rem;
  color: #8e9aad;
  font-weight: 500;
  letter-spacing: 0.01em;
  margin-top: 0.08em;
}
.status-dot {
  width: 34px;
  height: 34px;
  border-radius: 1.05rem;
  background: #f5f6fa;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
}
.status-dot .dot {
  width: 10px;
  height: 10px;
  background: #3ee696;
  border-radius: 50%;
  margin-right: 3px;
  box-shadow: 0 0 0 2px #c8f3e2;
}
.status-dot .dot2 {
  width: 10px;
  height: 10px;
  background: #3ee696;
  border-radius: 50%;
  margin-left: 3px;
  box-shadow: 0 0 0 2px #c8f3e2;
}
.leaderboard-close-btn {
  position: absolute; right: 1.3rem; top: 1.3rem; background: none; border: none;
  font-size: 1.5rem; color: #A0A3B2; cursor: pointer; z-index: 20;
  padding: 0.2em 0.45em; border-radius: 50%; transition: background 0.17s;
}
.leaderboard-close-btn:hover { background: #e7e9f5; color: #4F46E5;}
.leaderboard-name-form {
  display: flex; flex-direction: column; align-items: stretch; gap: 1.1rem;
  margin-bottom: 1.3em;
}
.leaderboard-name-form label {
  font-size: 1.11rem; color: #222; font-weight: 600; text-align: center; margin-bottom:0.3em;
}
.leaderboard-name-input {
  width: 100%; font-size: 1.18rem; padding: 0.56rem 1.1rem; border-radius: 1em; border: 1.5px solid #d3d6e2;
  box-sizing: border-box;
  margin-bottom: 0.2em;
}
.leaderboard-submit-btn {
  background: #14d8a6; color: #fff; font-weight: bold; font-size: 1.11rem;
  border: none; border-radius: 1.2em; padding: 0.5em 0; margin-top: 0.2em;
  cursor: pointer; transition: background 0.18s;
}
.leaderboard-submit-btn:hover { background: #0ea5e9;}
@media (max-width: 480px) {
  .leaderboard-container {
    padding: 1rem 0.25rem 2.1rem 0.25rem;
    border-radius: 1.2rem;
    max-width: 100vw;
  }
  .avatar { width: 38px; height: 38px; border-radius: 10px;}
  .leaderboard-title { font-size: 1.25rem;}
  .player-name { font-size: 1rem;}
  .player-score { font-size: 0.97rem;}
}
</style>
<!-- AUDIO for music and sound effects -->
<audio id="music-level1" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/GamebackgroundmusicLevel1.mp3" loop preload="auto"></audio>
<audio id="music-level2" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/GamebackgroundmusicLevel2.mp3" loop preload="auto"></audio>
<audio id="music-level3" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/GamebackgroundmusicLevel3.mp3" loop preload="auto"></audio>
<audio id="burst-level1" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/TileexplosionforLevel1.mp3" preload="auto"></audio>
<audio id="burst-level2" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/Tileexplosionforlevel2.mp3" preload="auto"></audio>
<audio id="burst-level3" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/Tileexplosionforlevel3.wav" preload="auto"></audio>
<audio id="gameover3" src="https://raw.githubusercontent.com/Parijat85/assets-audio/main/files/Audio/gameoverafterlevel3.mp3" preload="auto"></audio>
</head>
<body>
<div id="game-container" class="game-container"></div>
<div id="instruction-overlay" class="instruction-overlay">
    <div class="instruction-box">
        <div class="instruction-title">Welcome to the JARL Competency Game!</div>
        <div class="instruction-text">
            Tap words that fit the category at the top.<br>
            Match them all to clear the screen!
        </div>
        <div class="instruction-highlight" style="color:#9f7aea;">
            Aim for the highest score and post it!
        </div>
        <button class="start-btn" id="start-btn">Let's Start</button>
    </div>
</div>
<div id="competency-flash" class="competency-flash" style="display:none;">
  <span class="competency-flash-text"></span>
</div>
<canvas id="confetti-canvas" class="confetti" style="display:none;"></canvas>
<div id="leaderboard-overlay" class="leaderboard-overlay" style="display:none;">
  <div class="leaderboard-container">
    <button class="leaderboard-close-btn" onclick="hideLeaderboard()" title="Close">&times;</button>
    <div id="leaderboard-content"></div>
  </div>
</div>
<script>
// --- AUDIO CONTROL ---
function playMusicForLevel(level) {
    pauseAllMusic();
    const audio = document.getElementById('music-level' + level);
    if (audio) { audio.currentTime = 0; audio.volume = 0.33; audio.play().catch(()=>{}); }
}
function pauseAllMusic() {
    for (let i = 1; i <= 3; i++) {
        const audio = document.getElementById('music-level' + i);
        if (audio) { audio.pause(); audio.currentTime = 0; }
    }
}
function playBurstSound(level) {
    const burst = document.getElementById('burst-level' + level);
    if (burst) { burst.currentTime = 0; burst.volume = 0.7; burst.play().catch(()=>{}); }
}
function playGameOver3() {
    const audio = document.getElementById('gameover3');
    if (audio) { audio.currentTime = 0; audio.volume = 0.6; audio.play().catch(()=>{}); }
}

// === V22 GAME LOGIC ===
const competencyData = {
"Judgement":["Managing Ambiguity","Decision Making","Business Appreciation","Strategic Mindset"],
"Achievement Orientation":["Driving Ambitious Goals","Accountability","Operational Excellence","Being Resilient"],
"Relationship":["Managing Conflicts","Interpersonal Communication","Collaboration","Developing Teams"],
"Learning Agility":["Improvement Orientation","Adaptability","Innovation","Tech Savviness (Digital Mindset)"]
};
const subCompetencyDefs = {
"Managing Ambiguity":"Seeks clarity by asking questions and focuses on completing tasks",
"Decision Making":"Collects required information and evaluates options to decide",
"Business Appreciation":"Understands how their role impacts team or project objectives.",
"Strategic Mindset":"Focuses on tasks with long-term goals in mind.",
"Driving Ambitious Goals":"Sets stretch goals for personal development and completion of tasks.",
"Accountability":"Delivers assigned outcomes and takes ownership of personal results.",
"Operational Excellence":"Plans and executes tasks efficiently, ensuring optimal use of resources.",
"Being Resilient":"Remains calm under pressure and bounces back from minor setbacks.",
"Managing Conflicts":"Resolves simple disputes constructively using active listening.",
"Interpersonal Communication":"Communicates clearly and confidently in routine interactions, ensuring messages are coherent and well-understood.",
"Collaboration":"Cooperates with peers to achieve common goals.",
"Developing Teams":"Contributes to team development by actively engaging in peer learning",
"Improvement Orientation":"Actively requests feedback for personal improvement and applies it diligently.",
"Adaptability":"Quickly adjusts to new tasks or tools with minimal disruption.",
"Innovation":"Suggests creative ideas to address recurring challenges.",
"Tech Savviness (Digital Mindset)":"Proactively learns new digital tools to enhance personal efficiency."
};
const LEVEL1_2_TIME = 120, LEVEL3_TIME = 180;
let score=0, timeLeft=LEVEL1_2_TIME, gameActive=true, timer=null, level=1;
let blocks=[],currentCompetency='';
let l2_blocks=[],l2_selected=[],l2_feedback='',l2_matchedPairs=[];
let l3_blocks=[],l3_currentMain="",l3_shownDefs=[],l3_matchIndex=0;
let l3_eliminated=new Set(),l3_correctMatches=[],l3_summaryActive=false,l3_tryAgain=false;
let l3_mainCycle=[],l3_cycleIndex=0;

// === LEADERBOARD LOGIC ===
const avatars = [
  "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=alien",
  "https://api.dicebear.com/7.x/avataaars/svg?seed=pilched&backgroundColor=yellow",
  "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=cactusCowboy1",
  "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=cactusCowboy2&backgroundColor=peach",
  "https://api.dicebear.com/7.x/avataaars/svg?seed=doctor&backgroundColor=blue",
  "https://api.dicebear.com/7.x/avataaars/svg?seed=robot&backgroundColor=green",
  "https://api.dicebear.com/7.x/avataaars/svg?seed=fox&backgroundColor=orange",
  "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=astronaut"
];
let leaderboard = [
  { name: "Players", score: 322, avatar: avatars[0] },
  { name: "Pilched", score: 7034, avatar: avatars[1] },
  { name: "Mayre", score: 3625, avatar: avatars[2] },
  { name: "Tuotentus", score: 834, avatar: avatars[3] },
  { name: "Near Masto", score: 804, avatar: avatars[4] }
];
// ...all leaderboard code unchanged...

function renderLeaderboard(list, highlightName) {
  const content = document.getElementById('leaderboard-content');
  let html = `<div class="leaderboard-title">LEADERBOARD</div>
    <ul class="leaderboard-list">`;
  let sortedList = [...list].sort((a, b) => b.score - a.score);
  sortedList.forEach(entry => {
    html += `
      <li class="leaderboard-entry" style="${highlightName && entry.name === highlightName ? 'background:#e0fdf6;' : ''}">
        <span class="avatar"><img src="${entry.avatar}" width="54" height="54" alt="" style="display:block"></span>
        <span class="player-info">
          <span class="player-name">${entry.name}</span>
          <span class="player-score">${entry.score}</span>
        </span>
        <span class="status-dot">
          <span class="dot"></span><span class="dot2"></span>
        </span>
      </li>
    `;
  });
  html += `</ul>`;
  content.innerHTML = html;
}
function shuffleArray(array){const newArray=[...array];for(let i=newArray.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[newArray[i],newArray[j]]=[newArray[j],newArray[i]];}return newArray;}
function formatTime(seconds){const mins=Math.floor(seconds/60);const secs=seconds%60;return `${mins}:${secs<10?'0':''}${secs}`;}
function getCategoryColor(category){switch(category){case'Judgement':return['#DBEAFE','#93C5FD','#1D4ED8'];case'Achievement Orientation':return['#DCFCE7','#86EFAC','#16A34A'];case'Relationship':return['#F3E8FF','#C084FC','#7E22CE'];case'Learning Agility':return['#FEF3C7','#FCD34D','#B45309'];default:return['#F3F4F6','#D1D5DB','#4B5563'];}}
function getCategoryMainColor(category){switch(category){case'Judgement':return'#1D4ED8';case'Achievement Orientation':return'#16A34A';case'Relationship':return'#7E22CE';case'Learning Agility':return'#B45309';default:return'#111';}}

// --- MODIFIED startGame(levelNum) to play music ---
function startGame(levelNum){
    level=levelNum;l3_summaryActive=false;l3_tryAgain=false;
    playMusicForLevel(levelNum); // Play correct bg music for level
    const modalOverlay=document.querySelector('.modal-overlay');
    if(modalOverlay) modalOverlay.remove();
    document.getElementById('game-container').style.display='';
    if(timer) clearInterval(timer);
    if(level===3)timeLeft=LEVEL3_TIME;else timeLeft=LEVEL1_2_TIME;
    score=0;gameActive=true;
    if(level===1){
        blocks=Object.entries(competencyData).flatMap(([category,items])=>
            items.map(text=>({id:Math.random().toString(36).substr(2,9)+Date.now()+Math.random(),text,category,eliminated:false}))
        );
        blocks=shuffleArray(blocks);
        currentCompetency=Object.keys(competencyData)[0];
        timer=setInterval(updateTimer,1000);render();
    }else if(level===2){
        l2_blocks=Object.entries(competencyData).flatMap(([category,items])=>
            items.map(text=>({id:Math.random().toString(36).substr(2,9)+Date.now()+Math.random(),text,category,eliminated:false}))
        );
        l2_blocks=shuffleArray(l2_blocks);
        l2_selected=[];l2_feedback='';l2_matchedPairs=[];
        timer=setInterval(updateTimer,1000);render();
    }else if(level===3){
        l3_blocks=Object.entries(competencyData).flatMap(([category,items])=>
            items.map(text=>({id:Math.random().toString(36).substr(2,9)+Date.now()+Math.random(),text,category,eliminated:false}))
        );
        l3_blocks=shuffleArray(l3_blocks);l3_mainCycle=shuffleArray(Object.keys(competencyData));
        l3_cycleIndex=0;l3_currentMain=l3_mainCycle[l3_cycleIndex];
        l3_shownDefs=shuffleArray([...competencyData[l3_currentMain]]);
        l3_matchIndex=0;l3_eliminated=new Set();l3_correctMatches=[];
        l3_summaryActive=false;l3_tryAgain=false;
        timer=setInterval(updateTimer,1000);render();
    }
}
function updateTimer(){if(!gameActive)return;timeLeft--;if(timeLeft<=0){endGame();}updateTimerBar();}
function updateTimerBar(){
    const timerFill=document.querySelector('.timer-fill');
    if(!timerFill)return;
    const percentage=(timeLeft/(level===3?LEVEL3_TIME:LEVEL1_2_TIME))*100;
    timerFill.style.width=`${percentage}%`;
    if(percentage>66){timerFill.style.backgroundColor='#22C55E';}
    else if(percentage>33){timerFill.style.backgroundColor='#EAB308';}
    else{timerFill.style.backgroundColor='#EF4444';}
}
document.getElementById('game-container').addEventListener('click',function(e){
    const blockDiv=e.target.closest('.block[data-id]');
    if(blockDiv&&!blockDiv.classList.contains('eliminated')&&level===1){
        handleBlockClick(blockDiv.getAttribute('data-id'));
    }
});
function handleBlockClick(id){
    if(!gameActive||level!==1)return;
    const block=blocks.find(b=>b.id===id);
    if(!block||block.eliminated)return;
    const blockElement=document.querySelector(`[data-id="${id}"]`);
    if(block.category===currentCompetency){
        score+=5;block.eliminated=true;
        if(blockElement){blockElement.classList.add('eliminated');createParticles(blockElement,block.category);}
        const remainingForCategory=blocks.filter(b=>b.category===currentCompetency&&!b.eliminated);
        if(remainingForCategory.length===0){
            const remainingCompetencies=Object.keys(competencyData).filter(category=>
                blocks.some(b=>b.category===category&&!b.eliminated)
            );
            if(remainingCompetencies.length>0){currentCompetency=remainingCompetencies[0];}else{endGame();}
        }
    }else{
        score=Math.max(0,score-1);
        if(blockElement){blockElement.classList.add('shake');setTimeout(()=>blockElement.classList.remove('shake'),500);}
    }
    render();
}
function handleLevel2BlockClick(id){
    if(!gameActive||level!==2)return;
    const idx=l2_blocks.findIndex(b=>b.id===id);
    if(idx===-1||l2_blocks[idx].eliminated)return;
    if(l2_selected.length===0){
        l2_selected=[id];l2_feedback='';render();
    }else if(l2_selected.length===1){
        if(l2_selected[0]===id)return;
        l2_selected[1]=id;render();
        setTimeout(()=>{
            const blockA=l2_blocks.find(b=>b.id===l2_selected[0]);
            const blockB=l2_blocks.find(b=>b.id===l2_selected[1]);
            const elA=document.querySelector(`[data-id="${blockA.id}"]`);
            const elB=document.querySelector(`[data-id="${blockB.id}"]`);
            if(blockA.category===blockB.category){
                blockA.eliminated=true;blockB.eliminated=true;
                l2_matchedPairs.push({a:blockA.text,b:blockB.text,category:blockA.category});score+=10;
                if(elA){elA.classList.add('bursting');createParticles(elA,blockA.category,20);}
                if(elB){elB.classList.add('bursting');createParticles(elB,blockB.category,20);}
                showCompetencyFlash(blockA.category);
                setTimeout(()=>{if(elA)elA.classList.remove('bursting');if(elB)elB.classList.remove('bursting');l2_feedback='';render();},800);
                if(l2_blocks.filter(b=>!b.eliminated).length===0){setTimeout(()=>endGame(),800);}
            }else{
                score=Math.max(0,score-2);
                if(elA)elA.classList.add('shake');
                if(elB)elB.classList.add('shake');
                setTimeout(()=>{if(elA)elA.classList.remove('shake');if(elB)elB.classList.remove('shake');},500);
                l2_feedback="Not a pair!";setTimeout(()=>{l2_feedback='';render();},1000);
            }
            l2_selected=[];render();
        },200);
    }
}
window.handleLevel2BlockClick=handleLevel2BlockClick;

// --- MODIFIED createParticles to play burst sound for current level ---
function createParticles(element,category,count=14){
    playBurstSound(level);
    const rect=element.getBoundingClientRect();
    const centerX=rect.left+rect.width/2+window.scrollX;
    const centerY=rect.top+rect.height/2+window.scrollY;
    const colors={"Judgement":"#1D4ED8","Achievement Orientation":"#16A34A","Relationship":"#7E22CE","Learning Agility":"#B45309"};
    for(let i=0;i<count;i++){
        const particle=document.createElement('div');
        particle.className='particle';document.body.appendChild(particle);
        const angle=(i/count)*360+(Math.random()*15-7);
        const rad=angle*Math.PI/180;
        const startX=centerX,startY=centerY;
        particle.style.left=`${startX}px`;particle.style.top=`${startY}px`;
        particle.style.background=colors[category]||"#FCD34D";
        particle.style.border="2px solid #fff";
        particle.style.boxShadow=`0 0 16px 2px ${colors[category]||"#FCD34D"}`;
        const dist=60+Math.random()*30;
        const anim=particle.animate([
            {transform:'scale(1)',opacity:1},
            {transform:`translate(${Math.cos(rad)*dist}px,${Math.sin(rad)*dist}px) scale(0.5)`,opacity:0}
        ],{duration:900+Math.random()*150,easing:'cubic-bezier(.7,1.6,.7,1)'});
        anim.onfinish=()=>particle.remove();
    }
}
function handleLevel3BlockClick(subName){
    if(!gameActive||level!==3||l3_summaryActive||l3_tryAgain)return;
    const correct=l3_shownDefs[l3_matchIndex];
    const block=l3_blocks.find(b=>b.text===subName&&!l3_eliminated.has(subName));
    const blockElem=document.querySelector(`[data-l3="${subName}"]`);
    if(!block||!blockElem)return;
    if(subName===correct){
        l3_eliminated.add(subName);
        blockElem.classList.add('correct');
        setTimeout(()=>{blockElem.classList.add('eliminated');},700);
        confettiBurst();score+=10;
        l3_correctMatches.push({main:l3_currentMain,sub:subName,def:subCompetencyDefs[subName]});
        l3_matchIndex++;
        setTimeout(()=>{
            let allMatched=l3_blocks.length===l3_eliminated.size;
            if(l3_matchIndex>=l3_shownDefs.length&&!allMatched){
                l3_cycleIndex++;
                if(l3_cycleIndex<l3_mainCycle.length){
                    l3_currentMain=l3_mainCycle[l3_cycleIndex];
                    l3_shownDefs=shuffleArray([...competencyData[l3_currentMain]]);
                    l3_matchIndex=0;render();
                }
            }else if(allMatched){endGame();}else{render();}
        },900);
    }else{
        blockElem.classList.add('shake');score=Math.max(0,score-2);
        setTimeout(()=>blockElem.classList.remove('shake'),600);
    }
}
window.handleLevel3BlockClick=handleLevel3BlockClick;
function confettiBurst(){
    const canvas=document.getElementById('confetti-canvas');
    canvas.width=window.innerWidth;canvas.height=window.innerHeight;canvas.style.display='';
    const ctx=canvas.getContext('2d');let confettiPieces=[];
    const colors=['#1D4ED8','#16A34A','#7E22CE','#B45309','#F59E42','#FFD600','#62d9cc','#8368d7'];
    for(let i=0;i<80;i++){
        confettiPieces.push({
            x:canvas.width/2,y:canvas.height/2,r:6+Math.random()*6,
            dx:(Math.random()-0.5)*14,dy:(Math.random()-1.2)*12,
            color:colors[Math.floor(Math.random()*colors.length)],
            angle:Math.random()*2*Math.PI,dangle:(Math.random()-0.5)*0.18
        });
    }
    let frame=0;
    function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const c of confettiPieces){
            ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.angle);
            ctx.fillStyle=c.color;ctx.beginPath();ctx.arc(0,0,c.r,0,2*Math.PI);ctx.fill();ctx.restore();
            c.x+=c.dx;c.y+=c.dy;c.dy+=0.29;c.dx*=0.985;c.angle+=c.dangle;
        }
        frame++;if(frame<48){requestAnimationFrame(animate);}else{ctx.clearRect(0,0,canvas.width,canvas.height);canvas.style.display='none';}
    }
    animate();
}
function showCompetencyFlash(category){
    const flash=document.getElementById('competency-flash');
    const text=flash.querySelector('.competency-flash-text');
    const color=getCategoryMainColor(category);
    flash.style.display='flex';flash.style.color=color;text.textContent=category+'!';
    text.style.borderColor=color;text.style.background=`${color}e6`;text.style.boxShadow=`0 0 70px 30px ${color}77`;
    setTimeout(()=>{flash.style.display='none';},1200);
}

// --- MODIFIED endGame() to stop music, play gameover after level 3 win ---
function endGame(){
    gameActive=false;
    pauseAllMusic();
    if(level===3 && l3_blocks.length===l3_eliminated.size) playGameOver3();
    if(timer)clearInterval(timer);
    if(level===1){showResultsLevel1();}
    else if(level===2){showResultsLevel2();}
    else if(level===3){
        if(l3_blocks.length!==l3_eliminated.size){l3_tryAgain=true;render();}
        else{l3_summaryActive=true;render();}
    }
}

function showResultsLevel1(){
    const timeTaken=LEVEL1_2_TIME-timeLeft;
    const modal=document.createElement('div');
    modal.className='modal-overlay';
    modal.innerHTML=`
        <div class="modal">
            <div class="success-icon">✓</div>
            <h2 class="modal-title">Level Complete!</h2>
            <div class="modal-stats">
                <div class="modal-stat">
                    <p class="modal-stat-label">FINAL SCORE</p>
                    <p class="modal-stat-value">${score}</p>
                </div>
                <div class="modal-stat">
                    <p class="modal-stat-label">TIME TAKEN</p>
                    <p class="modal-stat-value">${formatTime(timeTaken)}</p>
                </div>
            </div>
            <p class="modal-message">
                Congratulations! You've successfully matched all competencies with their correct elements.
            </p>
            <div class="button-group">
                <button class="button button-primary" onclick="showMapping()">
                    Show Competency Mapping
                </button>
                <button class="button button-success" onclick="startGame(2)">
                    Play Next Level
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function showResultsLevel2(){
    const timeTaken=LEVEL1_2_TIME-timeLeft;
    const grouped={};for(const pair of l2_matchedPairs){
        if(!grouped[pair.category])grouped[pair.category]=[];grouped[pair.category].push(pair);}
    const displayOrder=["Judgement","Achievement Orientation","Relationship","Learning Agility"];
    const modal=document.createElement('div');
    modal.className='modal-overlay';
    modal.innerHTML=`
        <div class="modal">
            <div class="success-icon">✓</div>
            <h2 class="modal-title">Level 2 Complete!</h2>
            <div class="modal-stats">
                <div class="modal-stat">
                    <p class="modal-stat-label">FINAL SCORE</p>
                    <p class="modal-stat-value">${score}</p>
                </div>
                <div class="modal-stat">
                    <p class="modal-stat-label">TIME TAKEN</p>
                    <p class="modal-stat-value">${formatTime(timeTaken)}</p>
                </div>
            </div>
            <div class="pairs-summary">
                <h3 style="margin-bottom:1rem;">Your Matched Pairs:</h3>
                ${
                    displayOrder.map(cat =>
                        grouped[cat]
                        ? `<div class="pairs-bucket">
                                <div class="pairs-bucket-title">${cat}</div>
                                <ul class="pairs-list">
                                  ${grouped[cat].map(p => `<li>${p.a} &amp; ${p.b}</li>`).join('')}
                                </ul>
                            </div>`
                        : ''
                    ).join('')
                }
            </div>
            <div class="button-group">
                <button class="button button-primary" onclick="showMapping()">
                    Show Competency Mapping
                </button>
                <button class="button button-success" onclick="restartLevel2()">
                    Restart Level 2
                </button>
                <button class="button button-primary" style="background:#2563eb" onclick="startGame(3)">
                    Play Level 3
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
// ...rest of your mapping, leaderboard, rendering functions unchanged...
function showMapping(){
    const modal=document.querySelector('.modal');
    let mappingHTML=`
        <h2 class="modal-title">Competency Framework</h2>
        <div class="competency-mapping">
            <div class="mapping-grid">
    `;
    Object.entries(competencyData).forEach(([category,elements])=>{
        const [bgColor,borderColor]=getCategoryColor(category);
        mappingHTML+=`
            <div class="mapping-card" style="background-color: ${bgColor}; border-color: ${borderColor}">
                <h3 class="mapping-card-title">${category}</h3>
                <ul class="mapping-list">
                    ${elements.map(element=>`<li>${element}</li>`).join('')}
                </ul>
            </div>
        `;
    });
    mappingHTML+=`
            </div>
            <div class="button-group" style="margin-top: 1.5rem">
                <button class="button button-success" onclick="closeMappingAndPlayNextLevel()">
                    Play Level ${level===2?3:2}
                </button>
            </div>
        </div>
    `;
    modal.innerHTML=mappingHTML;
}
function closeMappingAndPlayNextLevel(){
    const modalOverlay=document.querySelector('.modal-overlay');
    if(modalOverlay)modalOverlay.remove();
    if(level===2){startGame(3);}else{startGame(2);}
}
function restartLevel2(){
    const modalOverlay=document.querySelector('.modal-overlay');
    if(modalOverlay)modalOverlay.remove();startGame(2);
}
window.handleLevel2BlockClick=handleLevel2BlockClick;
window.showMapping=showMapping;
window.closeMappingAndPlayNextLevel=closeMappingAndPlayNextLevel;
window.restartLevel2=restartLevel2;

function showLeaderboardPrompt(playerScore) {
  const overlay = document.getElementById('leaderboard-overlay');
  overlay.style.display = 'flex';
  const content = document.getElementById('leaderboard-content');
  content.innerHTML = `
    <div class="leaderboard-title">Congratulations!</div>
    <form class="leaderboard-name-form" id="leaderboard-name-form" autocomplete="off">
      <label for="player-name">Enter your name to join the leaderboard:</label>
      <input type="text" maxlength="16" required placeholder="Your name" class="leaderboard-name-input" id="player-name" autocomplete="off"/>
      <button type="submit" class="leaderboard-submit-btn">Submit Score</button>
    </form>
  `;
  setTimeout(() => {
    document.getElementById('player-name').focus();
  }, 100);
  document.getElementById('leaderboard-name-form').onsubmit = function(e) {
    e.preventDefault();
    let playerName = document.getElementById('player-name').value.trim().substring(0,16);
    if (!playerName) return;
    const avatar = avatars[Math.floor(Math.random() * avatars.length)];
    leaderboard.push({ name: playerName, score: playerScore, avatar });
    renderLeaderboard(leaderboard, playerName);
    setTimeout(() => {
      const form = document.getElementById('leaderboard-name-form');
      if (form) form.remove();
    }, 30);
  };
}
function showLeaderboardOnly() {
  document.getElementById('leaderboard-overlay').style.display = 'flex';
  renderLeaderboard(leaderboard);
}
function hideLeaderboard() {
  document.getElementById('leaderboard-overlay').style.display = 'none';
  document.getElementById('game-container').style.display = '';
  startGame(1);
}

// === RENDER ===
function render() {
    const container = document.getElementById('game-container');
    if (level === 3 && l3_tryAgain) {
        container.innerHTML = `
            <div class="l3-tryagain-main">Try Again!</div>
            <div class="l3-tryagain-msg">You didn't match all sub-competencies in the time limit.<br>Click below to retry Level 3.</div>
            <div style="text-align:center;">
                <button class="button button-success" onclick="startGame(3)">Restart Level 3</button>
            </div>
        `;
        return;
    }
    if (level === 3 && l3_summaryActive) {
        container.innerHTML = `
            <div class="game-header">
                <div><h1 class="game-title">Level 3 Complete!</h1></div>
            </div>
            <div class="timer-bar">
                <div class="timer-track">
                    <div class="timer-fill" style="width: 100%"></div>
                </div>
            </div>
            <div style="font-size:1.25rem;font-weight:bold;color:#4F46E5;text-align:center;margin: 1.2rem 0 0.7rem 0;">All Competencies & Definitions</div>
            <div class="l3-summary-scroll">
                ${Object.keys(competencyData).map(cat =>
                    `<div class="l3-summary-block">
                        <div class="l3-summary-main-title">${cat}</div>
                        ${competencyData[cat].map(sub =>
                            `<div class="l3-summary-sub-title">${sub}</div>
                            <div class="l3-summary-def">${subCompetencyDefs[sub]}</div>`
                        ).join('')}
                    </div>`
                ).join('')}
            </div>
            <div style="text-align:center; margin-bottom:1.5em;">
               <button class="button button-success" onclick="showLeaderboardPrompt(${score})">
                 See Leaderboard & Submit Your Score
               </button>
            </div>
        `;
        return;
    }
    if (level === 1) {
        container.innerHTML = `
            <div class="game-header">
                <div>
                    <h1 class="game-title">Competency Matcher</h1>
                    <p class="game-subtitle">Match the sub-elements to their competency</p>
                </div>
                <div class="game-stats">
                    <div class="stat">
                        <p class="stat-label">Score</p>
                        <p class="stat-value">${score}</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Remaining</p>
                        <p class="stat-value">${blocks.filter(b => !b.eliminated).length}</p>
                    </div>
                </div>
            </div>
            <div class="timer-bar">
                <div class="timer-track">
                    <div class="timer-fill" style="width: ${(timeLeft / 120) * 100}%"></div>
                </div>
            </div>
            <div class="current-competency">
                <h2 class="competency-label">Current Competency</h2>
                <div class="competency-tag">${currentCompetency}</div>
            </div>
            <div class="blocks-grid">
                ${blocks.map(block => {
                    const [bgColor, borderColor, textColor] = getCategoryColor(block.category);
                    return `
                        <div
                            class="block ${block.eliminated ? 'eliminated' : ''}"
                            style="background-color: ${bgColor}; border-color: ${borderColor}; color: ${textColor}"
                            data-id="${block.id}"
                        >
                            ${block.text}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    } else if (level === 2) {
        container.innerHTML = `
            <div class="game-header">
                <div>
                    <h1 class="game-title">Competency Pair Matcher - Level 2</h1>
                    <p class="game-subtitle">Select two words that belong to the same competency</p>
                </div>
                <div class="game-stats">
                    <div class="stat">
                        <p class="stat-label">Score</p>
                        <p class="stat-value">${score}</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Remaining</p>
                        <p class="stat-value">${l2_blocks.filter(b => !b.eliminated).length}</p>
                    </div>
                </div>
            </div>
            <div class="timer-bar">
                <div class="timer-track">
                    <div class="timer-fill" style="width: ${(timeLeft / 120) * 100}%"></div>
                </div>
            </div>
            <div class="pair-instruction">
                <div style="font-size:1.1rem;">Select a pair of words that belong to the same competency bucket.</div>
                ${l2_feedback ? `<div class="level2-feedback">${l2_feedback}</div>` : ''}
            </div>
            <div class="blocks-grid">
                ${l2_blocks.map(block => {
                    const [bgColor, borderColor, textColor] = getCategoryColor(block.category);
                    const selected = l2_selected.includes(block.id) ? 'selected' : '';
                    return `
                        <div
                            class="block ${block.eliminated ? 'eliminated' : ''} ${selected}"
                            style="background-color: ${bgColor}; border-color: ${borderColor}; color: ${textColor}"
                            data-id="${block.id}"
                            onclick="handleLevel2BlockClick('${block.id}')"
                        >
                            ${block.text}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    } else if (level === 3) {
        const [bgColor, borderColor, colorHex] = getCategoryColor(l3_currentMain);
        let subGrid = shuffleArray(l3_blocks.map(b => b.text)).map(sub => {
            let classes = "l3-block";
            if (l3_eliminated.has(sub)) classes += " eliminated";
            return `<div class="${classes}" data-l3="${sub}" onclick="handleLevel3BlockClick('${sub}')">${sub}</div>`;
        }).join('');
        container.innerHTML = `
            <div class="game-header">
                <div>
                    <h1 class="game-title">Competency Definition Matcher - Level 3</h1>
                </div>
                <div class="game-stats">
                    <div class="stat">
                        <p class="stat-label">Score</p>
                        <p class="stat-value">${score}</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Remaining</p>
                        <p class="stat-value">${l3_blocks.length - l3_eliminated.size}</p>
                    </div>
                </div>
            </div>
            <div class="timer-bar">
                <div class="timer-track">
                    <div class="timer-fill" style="width: ${(timeLeft / 180) * 100}%"></div>
                </div>
            </div>
            <div class="l3-main-title" style="color:${colorHex};">${l3_currentMain}</div>
            <div class="l3-def-label">Element Definition</div>
            <div class="l3-def-box">${subCompetencyDefs[l3_shownDefs[l3_matchIndex]]}</div>
            <div class="l3-grid">
                ${subGrid}
            </div>
        `;
    }
}
document.getElementById('start-btn').onclick=()=>{
    const overlay=document.getElementById('instruction-overlay');
    overlay.style.opacity='0';setTimeout(()=>overlay.remove(),400);startGame(1);
};
document.getElementById('game-container').style.display='none';
window.addEventListener('resize',()=>{
    const canvas=document.getElementById('confetti-canvas');
    canvas.width=window.innerWidth;canvas.height=window.innerHeight;
});
</script>
</body>
</html>